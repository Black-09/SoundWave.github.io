<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda de Canciones</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            padding: 20px;
            margin: 0;
        }
        h1 {
            color: #1db954;
            text-align: center;
        }
        #song-name {
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            background-color: #282828;
            color: #ffffff;
        }
        #suggestions-container {
            margin-top: 10px;
        }
        .suggestion {
            cursor: pointer;
            padding: 10px;
            background-color: #282828;
            border-radius: 10px;
            margin-top: 5px;
            color: #ffffff;
            transition: background-color 0.3s;
        }
        .suggestion:hover {
            background-color: #383838;
        }
        #search-button {
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            background-color: #1db954;
            color: #ffffff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #search-button:hover {
            background-color: #1ed760;
        }
        #filtered-content {
            background-color: #282828;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            color: #ffffff;
        }
        #filtered-content a {
            color: #1db954;
            text-decoration: none;
        }
        #filtered-content a:hover {
            text-decoration: underline;
        }
        #audio-player {
            width: 100%;
            margin-top: 20px;
            background-color: #282828;
            border-radius: 10px;
        }
        #source-links {
            display: none; /* Ocultar el contenedor de enlaces */
        }
        @media (min-width: 768px) {
            #song-name, #search-button {
                width: 50%;
                margin-left: 25%;
            }
            #filtered-content {
                width: 70%;
                margin-left: 15%;
            }
        }
    </style>
</head>
<body>
    <h1>Búsqueda de Canciones</h1>
    <input type="text" id="song-name" placeholder="Ingresa el nombre de la canción" />
    <div id="suggestions-container"></div>
    <button id="search-button">Buscar</button>

    <div id="filtered-content"></div>

    <!-- Contenedor de enlaces (oculto) -->
    <div id="source-links"></div>

    <!-- Reproductor de audio -->
    <h2>Reproducir Audio</h2>
    <audio id="audio-player" controls>
        Tu navegador no soporta la reproducción de audio.
    </audio>

    <script>
        const suggestionsContainer = document.getElementById('suggestions-container');
        const sourceLinksContainer = document.getElementById('source-links');
        const audioPlayer = document.getElementById('audio-player');
        let selectedVideoId = null;
        let selectedTitle = null;
        let currentSuggestions = []; // Almacenar las sugerencias actuales
        let currentIndex = 0; // Índice para recorrer las sugerencias

        // Permitir la reproducción automática después de cualquier interacción del usuario
        document.addEventListener('click', enableAutoplay, { once: true });

        function enableAutoplay() {
            console.log('Interacción del usuario detectada. La reproducción automática está habilitada.');
        }

        document.getElementById('song-name').addEventListener('input', function() {
            const songName = this.value;
            suggestionsContainer.innerHTML = ''; // Limpiar sugerencias anteriores

            if (songName) {
                const url = 'https://inv.nadeko.net/search?q=' + encodeURIComponent(songName);
                
                // Hacer la solicitud a All Origins para obtener sugerencias
                fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url))
                    .then(response => {
                        if (response.ok) return response.text();
                        throw new Error('Network response was not ok.');
                    })
                    .then(data => {
                        // Crear un nuevo DOMParser
                        const parser = new DOMParser();
                        // Analizar el HTML
                        const doc = parser.parseFromString(data, 'text/html');
                        // Obtener todos los divs con la clase 'video-card-row'
                        const divs = doc.querySelectorAll('div.video-card-row');

                        // Filtrar y mostrar sugerencias
                        currentSuggestions = Array.from(divs).map(div => {
                            const link = div.querySelector('a');
                            const titleElement = link ? link.querySelector('p') : null;
                            const title = titleElement ? titleElement.innerText : 'Sin título';
                            const videoId = link ? link.getAttribute('href').split('v=')[1] : null;
                            return { title, videoId }; // Retornar el título y el videoId como sugerencia
                        }).slice(0, 5); // Limitar a 5 sugerencias

                        // Mostrar sugerencias
                        currentSuggestions.forEach((suggestion, index) => {
                            const suggestionElement = document.createElement('div');
                            suggestionElement.textContent = suggestion.title;
                            suggestionElement.classList.add('suggestion');
                            suggestionElement.addEventListener('click', function() {
                                document.getElementById('song-name').value = ''; // Limpiar el campo de búsqueda
                                selectedVideoId = suggestion.videoId; // Guardar el videoId seleccionado
                                selectedTitle = suggestion.title; // Guardar el título seleccionado
                                suggestionsContainer.innerHTML = ''; // Limpiar sugerencias
                                showSelectedSong(); // Mostrar la canción seleccionada
                                fetchSourceCode(selectedVideoId); // Obtener y verificar los enlaces <source src>
                            });
                            suggestionsContainer.appendChild(suggestionElement);
                        });
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
            }
        });

        document.getElementById('search-button').addEventListener('click', function() {
            const songName = document.getElementById('song-name').value;
            if (songName) {
                // Realizar una nueva búsqueda
                const url = 'https://inv.nadeko.net/search?q=' + encodeURIComponent(songName);

                fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url))
                    .then(response => {
                        if (response.ok) return response.text();
                        throw new Error('Network response was not ok.');
                    })
                    .then(data => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data, 'text/html');
                        const divs = doc.querySelectorAll('div.video-card-row');

                        const filteredContent = document.getElementById('filtered-content');
                        filteredContent.innerHTML = ''; // Limpiar contenido anterior

                        divs.forEach(div => {
                            const link = div.querySelector('a');
                            const videoId = link ? link.getAttribute('href').split('v=')[1] : null;
                            const titleElement = link ? link.querySelector('p') : null;
                            const title = titleElement ? titleElement.innerText : 'Sin título';

                            if (videoId) {
                                const videoElement = document.createElement('div');
                                videoElement.innerHTML = `<strong>${title}</strong> - <a href="https://inv.nadeko.net/watch?v=${videoId}&listen=1" target="_blank">Ver Video</a>`;
                                filteredContent.appendChild(videoElement);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
            } else {
                // Si no hay texto en el campo de búsqueda, mostrar la canción seleccionada (si existe)
                showSelectedSong();
            }
        });

        function showSelectedSong() {
            const filteredContent = document.getElementById('filtered-content');
            filteredContent.innerHTML = '';

            if (selectedVideoId && selectedTitle) {
                const videoElement = document.createElement('div');
                videoElement.innerHTML = `<strong>${selectedTitle}</strong> - <a href="https://inv.nadeko.net/watch?v=${selectedVideoId}&listen=1" target="_blank">Ver Video</a>`;
                filteredContent.appendChild(videoElement);
            } else {
                filteredContent.innerHTML = 'No se ha seleccionado ninguna canción.';
            }
        }

        function fetchSourceCode(videoId) {
            const watchUrl = `https://inv.nadeko.net/watch?v=${videoId}&listen=1`;
            const allOriginsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(watchUrl)}`;

            fetch(allOriginsUrl)
                .then(response => {
                    if (response.ok) return response.text();
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    // Crear un nuevo DOMParser para analizar el código fuente
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');

                    // Esperar a que la página esté lista antes de buscar las etiquetas
                    waitForContent(doc);
                })
                .catch(error => {
                    console.error('Error fetching source code:', error);
                    sourceLinksContainer.textContent = 'No se pudo cargar el código fuente.';
                });
        }

        function waitForContent(doc, retries = 10, delay = 500) {
            // Buscar todas las etiquetas <source> y <audio>
            const sourceElements = doc.querySelectorAll('source[src]');
            const audioElements = doc.querySelectorAll('audio[src]');

            if (sourceElements.length > 0 || audioElements.length > 0) {
                // Si hay etiquetas <source> o <audio>, procesar los enlaces
                const sourceLinks = Array.from(sourceElements).map(source => source.src);
                const audioLinks = Array.from(audioElements).map(audio => audio.src);
                const allLinks = [...sourceLinks, ...audioLinks];
                checkAccessibleLinks(allLinks);
            } else if (retries > 0) {
                // Si no se encuentran etiquetas, esperar y volver a intentar
                console.log(`Esperando a que el contenido esté listo... (${retries} intentos restantes)`);
                setTimeout(() => {
                    waitForContent(doc, retries - 1, delay);
                }, delay);
            } else {
                // Si se agotan los intentos, buscar otro video
                console.log('No se encontraron etiquetas <source> ni <audio>. Buscando otro video...');
                findNextVideo();
            }
        }

        function findNextVideo() {
            currentIndex++;
            if (currentIndex < currentSuggestions.length) {
                // Intentar con el siguiente video de la lista de sugerencias
                selectedVideoId = currentSuggestions[currentIndex].videoId;
                selectedTitle = currentSuggestions[currentIndex].title;
                showSelectedSong();
                fetchSourceCode(selectedVideoId);
            } else {
                // Si no hay más sugerencias, mostrar un mensaje de error
                sourceLinksContainer.textContent = 'No se encontraron enlaces <source src> en ningún video.';
            }
        }

        function checkAccessibleLinks(links) {
            const accessibleLinks = [];

            // Función para verificar un enlace
            const checkLink = (link) => {
                return fetch(link)
                    .then(response => {
                        if (response.ok) {
                            return link; // El enlace es accesible
                        } else {
                            return null; // El enlace no es accesible
                        }
                    })
                    .catch(() => null); // Si hay un error, el enlace no es accesible
            };

            // Verificar todos los enlaces
            Promise.all(links.map(link => checkLink(link)))
                .then(results => {
                    // Filtrar los enlaces accesibles que no contienen la palabra "api"
                    const accessibleLinks = results.filter(link => {
                        return link !== null && !link.toLowerCase().includes('api');
                    });

                    // Mostrar los enlaces accesibles en el contenedor (aunque esté oculto)
                    if (accessibleLinks.length > 0) {
                        sourceLinksContainer.innerHTML = accessibleLinks
                            .map(link => `<div class="audio-link" onclick="playAudio('${link}')">${link}</div>`)
                            .join('\n');

                        // Reproducir automáticamente el primer enlace de audio accesible
                        if (accessibleLinks.length > 0) {
                            playAudio(accessibleLinks[0]);
                        }
                    } else {
                        // Si no hay enlaces accesibles, buscar otro video
                        findNextVideo();
                    }
                });
        }

        function playAudio(audioUrl) {
            // Establecer la fuente del reproductor de audio
            audioPlayer.src = audioUrl;

            // Intentar reproducir automáticamente después de una interacción del usuario
            audioPlayer.play()
                .then(() => {
                    console.log('Audio reproducido automáticamente.');
                })
                .catch(error => {
                    console.error('Error al reproducir el audio automáticamente:', error);
                    alert('Haz clic en el botón de reproducción del reproductor de audio.');
                });
        }
    </script>
</body>
</html>
