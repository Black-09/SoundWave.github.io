<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reproducir Enlace de Música</title>
</head>
<body>
  <h1>Reproducir Enlace de Música de Spotify</h1> 
  
  <label for="spotifyUrl">
    Canción de prueba EXCESOS - Fuerza Regida: https://open.spotify.com/track/6UtWwuheJr5LLDeVypPNx7
  </label>
  <br><br>

  <label for="spotifyUrl">
    Escuchar más canciones en Spotify: https://open.spotify.com/track/6CvTEtGagmzQvkUzzyKR9k
  </label>
  <br><br>

  <label for="spotifyUrl">Introduce la URL de Spotify:</label>
  <input type="text" id="spotifyUrl" placeholder="Ejemplo: https://open.spotify.com/track/" required>
  <br><br>

  <button id="playButton">Reproducir Música</button>

  <p id="playLink" style="display:block;">Esperando...</p>

  <audio id="audioPlayer" controls style="display:none;">
    Tu navegador no soporta el reproductor de audio.
  </audio>

  <p id="mp3Link" style="display:none;">
    <a href="#" target="_blank" id="downloadLink">Hacer clic para escuchar el MP3</a>
  </p>

  <!-- Mostrar tiempo de espera -->
  <p id="loadingTime" style="display:none;">Esperando para empezar... <span id="timeTaken">0</span> segundos.</p>

  <script>
    document.getElementById('playButton').addEventListener('click', async () => {
      let spotifyUrl = document.getElementById('spotifyUrl').value;

      // Eliminar las tildes y caracteres especiales en la URL
      spotifyUrl = spotifyUrl.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      try {
        // Mostrar el tiempo de carga
        const loadingTimeElement = document.getElementById('loadingTime');
        const timeTakenElement = document.getElementById('timeTaken');
        let startTime = Date.now();
        loadingTimeElement.style.display = 'block';

        // Hacer la solicitud POST al servidor Express
        const response = await fetch('https://jsnode-ab0e.onrender.com/get-download-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ spotifyUrl })
        });

        // Si la respuesta no es exitosa, lanzamos un error
        if (!response.ok) {
          throw new Error('Error al obtener el enlace de reproducción');
        }

        // Obtener el enlace de reproducción desde la respuesta
        const data = await response.json();
        const playLink = data.downloadLink;

        // Ocultar la URL y el texto "Esperando..."
        document.getElementById('playLink').style.display = 'none';

        // Mostrar el reproductor de audio y asignar el enlace
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.style.display = 'block';
        audioPlayer.src = playLink;

        // Cuando el audio esté listo para reproducirse
        audioPlayer.addEventListener('loadeddata', () => {
          let endTime = Date.now();
          let timeTaken = (endTime - startTime) / 1000; // tiempo en segundos
          timeTakenElement.textContent = timeTaken.toFixed(2); // Mostrar tiempo transcurrido
          audioPlayer.play();
        });

        // Ocultar el enlace al archivo MP3
        document.getElementById('mp3Link').style.display = 'none';

      } catch (error) {
        console.error('Error al hacer la solicitud:', error);
        document.getElementById('playLink').textContent = 'Error al obtener el enlace.';
      }
    });
  </script>
</body>
</html>
