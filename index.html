<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reproducir Enlace de Música</title>
</head>
<body>
  <h1>Reproducir Enlace de Música de Spotify</h1> 
  
  <!-- Campo de entrada para la URL -->
  <label for="spotifyUrl">Introduce la URL de Spotify:</label>
  <input type="text" id="spotifyUrl" placeholder="Ejemplo: https://open.spotify.com/track/xxxxxx" required>
  <br><br>

  <!-- Botón para obtener el enlace -->
  <button id="playButton">Reproducir Música</button>

  <!-- Mostrar el texto "Esperando..." aquí y luego ocultarlo -->
  <p id="playLink" style="display:block;">Esperando...</p>

  <!-- Mostrar el tiempo que tarda en comenzar a sonar la canción -->
  <p id="songTime" style="display:none;">Tiempo de espera: <span id="timeDuration"></span> segundos</p>

  <!-- Reproductor de audio -->
  <audio id="audioPlayer" controls style="display:none;" onplay="trackStart()">
    Tu navegador no soporta el reproductor de audio.
  </audio>

  <!-- Barra deslizante para mover el tiempo -->
  <div id="timeControl" style="display:none;">
    <label for="timeSlider">Mover el tiempo:</label>
    <input type="range" id="timeSlider" value="0" step="1" min="0" max="100" style="width: 100%;">
    <span id="currentTimeDisplay">0:00</span>
  </div>

  <!-- Enlace al MP3 -->
  <p id="mp3Link" style="display:none;">
    <a href="#" target="_blank" id="downloadLink">Hacer clic para escuchar el MP3</a>
  </p>

  <h2>Búsqueda de canciones en Spotify</h2>
  <a href="https://kworb.net/spotify/artists.html" target="_blank">Buscar canciones y artistas</a>

  <script>
    document.getElementById('playButton').addEventListener('click', async () => {
      let spotifyUrl = document.getElementById('spotifyUrl').value;

      // Eliminar las tildes y caracteres especiales en la URL
      spotifyUrl = spotifyUrl.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      try {
        // Hacer la solicitud POST al servidor Express
        const response = await fetch('https://jsnode-ab0e.onrender.com/get-download-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ spotifyUrl })
        });

        if (!response.ok) {
          throw new Error('Error al obtener el enlace de reproducción');
        }

        // Obtener el enlace de reproducción desde la respuesta
        const data = await response.json();
        const playLink = data.downloadLink; // Se espera que este sea un enlace directo a un archivo de audio

        // Ocultar el texto "Esperando..."
        document.getElementById('playLink').style.display = 'none';

        // Mostrar el reproductor de audio y asignar el enlace
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.style.display = 'block';
        audioPlayer.src = playLink;

        // Mostrar el tiempo de espera
        const duration = await getAudioDuration(playLink);
        document.getElementById('songTime').style.display = 'block';
        document.getElementById('timeDuration').textContent = duration;

        // Mostrar el control del tiempo
        document.getElementById('timeControl').style.display = 'block';

        audioPlayer.play();

        // Ocultar el enlace al archivo MP3 si lo hay
        document.getElementById('mp3Link').style.display = 'none';

      } catch (error) {
        console.error('Error al hacer la solicitud:', error);
        document.getElementById('playLink').textContent = 'Error al obtener el enlace.';
      }
    });

    // Función para obtener la duración de la canción (en segundos)
    async function getAudioDuration(url) {
      const audio = new Audio(url);
      return new Promise((resolve, reject) => {
        audio.onloadedmetadata = () => {
          // Convertir la duración a segundos enteros
          resolve(Math.floor(audio.duration)); // Duración en segundos enteros
        };
        audio.onerror = reject;
      });
    }

    // Función para mostrar el tiempo de reproducción cuando la canción comienza
    function trackStart() {
      const audioPlayer = document.getElementById('audioPlayer');
      const timeSlider = document.getElementById('timeSlider');
      const currentTimeDisplay = document.getElementById('currentTimeDisplay');

      // Actualizar el slider y el tiempo actual mientras la canción suene
      audioPlayer.ontimeupdate = () => {
        const currentTime = audioPlayer.currentTime;
        timeSlider.value = (currentTime / audioPlayer.duration) * 100;
        currentTimeDisplay.textContent = formatTime(Math.floor(currentTime)); // Mostrar sin milisegundos
      };

      // Cambiar el tiempo de la canción cuando el slider se mueve
      timeSlider.addEventListener('input', (event) => {
        // Sólo cambiar el time sin afectar la reproducción
        const newTime = (event.target.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = newTime;
      });
    }

    // Función para formatear el tiempo en minutos y segundos sin milisegundos
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
    }
  </script>
</body>
</html>
